# 即時同步與多人共用功能說明

## 🚀 已實現的功能

### 1. 即時數據同步

所有數據變更都會即時同步到所有在線成員的設備上，無需手動刷新頁面。

#### 費用記錄即時同步
- **新增費用**：當任何成員新增費用記錄時，其他成員的頁面會立即顯示新記錄
- **編輯費用**：修改費用記錄時，其他成員會即時看到更新
- **刪除費用**：刪除記錄時，其他成員的列表會立即移除該記錄

#### 旅程設置即時同步
- **人員管理**：新增或刪除人員時，所有成員的下拉選單會即時更新
- **分類管理**：修改分類標籤時，所有成員可以立即使用新分類
- **幣別管理**：新增幣別或修改匯率時，所有成員會即時同步

### 2. 多人共用功能

#### 旅程成員管理
- **邀請成員**：
  1. 點擊「邀請成員」按鈕
  2. 輸入成員的註冊 Email
  3. 被邀請的成員登入後即可看到該旅程
  4. 所有成員共享相同的數據

- **移除成員**：
  - 旅程創建者可以移除其他成員
  - 不能移除旅程創建者本人
  - 移除成員時會顯示確認對話框

#### 權限控制
- **旅程創建者權限**：
  - 可以邀請成員
  - 可以移除成員
  - 可以修改旅程設置（人員、分類、幣別）

- **普通成員權限**：
  - 可以查看旅程數據
  - 可以新增費用記錄
  - 可以編輯自己創建的費用記錄
  - 可以刪除自己創建的費用記錄
  - 可以修改旅程設置（人員、分類、幣別）

### 3. 訂閱管理

系統會自動管理 Real-time 訂閱：
- **選擇旅程時**：自動訂閱該旅程的費用記錄和設置更新
- **離開旅程時**：自動取消所有訂閱，釋放資源
- **切換旅程時**：自動取消舊訂閱，建立新訂閱

## 🔧 技術實現

### Real-time 訂閱機制

```typescript
// 訂閱費用記錄的即時更新
subscribeToExpenses(tripId: string)
- 監聽 INSERT 事件：新增記錄時自動添加到列表
- 監聽 UPDATE 事件：更新記錄時自動修改列表中的對應項目
- 監聽 DELETE 事件：刪除記錄時自動從列表中移除

// 訂閱旅程設置的即時更新
subscribeToTrip(tripId: string)
- 監聽 UPDATE 事件：旅程設置變更時自動更新本地狀態
- 自動同步人員、分類、幣別列表

// 取消所有訂閱
unsubscribeAll()
- 離開旅程時調用，清理資源
```

### 數據流向

```
用戶 A 操作 → Supabase 數據庫 → Real-time 廣播 → 用戶 B/C/D 自動更新
```

## 📝 使用場景示例

### 場景 1：多人同時記帳
1. 用戶 A 創建旅程「日本旅遊 2025」
2. 用戶 A 邀請用戶 B、C、D 加入
3. 用戶 B 記錄早餐費用 ¥2000
4. 用戶 C 的設備立即顯示這筆費用
5. 用戶 D 記錄午餐費用 ¥3500
6. 所有人的統計頁面即時更新

### 場景 2：即時修改設置
1. 用戶 A 新增一個分類「紀念品」
2. 用戶 B 的設備上立即可以選擇「紀念品」分類
3. 用戶 C 新增一個人員「小明」
4. 用戶 D 記錄費用時可以立即選擇「小明」作為參與者

### 場景 3：離線恢復
1. 用戶 A 在離線狀態下打開應用
2. 可以查看之前載入的數據
3. 重新連線後，自動同步最新數據
4. 其他成員的修改會自動更新到用戶 A 的設備

## ⚠️ 注意事項

### 網絡要求
- 需要穩定的網絡連接才能實現即時同步
- 離線時仍可查看已載入的數據
- 重新連線後會自動同步最新數據

### 性能考量
- Real-time 訂閱會保持一個 WebSocket 連接
- 對於大型旅程（數百筆記錄），載入時可能需要幾秒鐘
- 建議為每次旅行創建獨立的旅程，避免單一旅程過於龐大

### Supabase 限制
- 免費方案有併發連接限制（通常 2-5 個）
- 如果超過限制，新連接會失敗
- 建議小團隊使用（5 人以內）

## 🎯 最佳實踐

1. **及時離開不使用的旅程**：釋放 Real-time 連接資源
2. **定期清理過期數據**：保持旅程數據的整潔
3. **使用有意義的分類和標籤**：方便所有成員理解
4. **確保成員使用正確的 Email**：邀請時注意拼寫
5. **創建者定期檢查成員列表**：移除不再參與的成員

## 🔒 安全性

- 所有數據都受 Row Level Security (RLS) 保護
- 只有旅程成員可以訪問該旅程的數據
- 費用記錄只能由創建者刪除
- Email 確保成員身份的唯一性

